/*
Displays old vulnerabilities that have been remediated and any new vulnerabilities
*/

 WITH assets_vulns AS
(
         SELECT   fasv.asset_id,
                  fasv.vulnerability_id,
                  Baselinecomparison (fasv.scan_id, current_scan) AS baseline,
                  s.baseline_scan,
                  s.current_scan
         FROM     fact_asset_scan_vulnerability_instance fasv
         JOIN     dim_vulnerability dv
         ON       dv.vulnerability_id = fasv.vulnerability_id
         JOIN
                  (
                         SELECT asset_id,
                                scanasof (asset_id, (CURRENT_DATE - interval '1 month')) AS baseline_scan,
                                scanasof (asset_id, CURRENT_DATE)                        AS current_scan
                         FROM   dim_asset da) s
         ON       s.asset_id = fasv.asset_id
         AND      (
                           fasv.scan_id = s.baseline_scan
                  OR       fasv.scan_id = s.current_scan)
         WHERE    dv.severity = 'Critical'
         GROUP BY fasv.asset_id,
                  fasv.vulnerability_id,
                  s.baseline_scan,
                  s.current_scan
         HAVING   (
                           baselinecomparison (fasv.scan_id, current_scan) = 'Same')
         OR       (
                           baselinecomparison (fasv.scan_id, current_scan) = 'New')
         OR       (
                           baselinecomparison (fasv.scan_id, current_scan) = 'Old') ), baseline_scan_date AS
(
          SELECT    av.asset_id,
                    finished
          FROM      assets_vulns av
          LEFT JOIN dim_scan ds
          ON        ds.scan_id = av.baseline_scan
          GROUP BY  av.asset_id,
                    finished ), current_scan_date AS
(
          SELECT    av.asset_id,
                    finished
          FROM      assets_vulns av
          LEFT JOIN dim_scan ds
          ON        ds.scan_id = av.current_scan
          GROUP BY  av.asset_id,
                    finished ), existing_vulns AS
(
         SELECT   av.asset_id,
                  count (av.vulnerability_id) AS existing_vulns
         FROM     assets_vulns                AS av
         WHERE    av.baseline = 'Same'
         GROUP BY av.asset_id ), new_vulns AS
(
         SELECT   av.asset_id,
                  count (av.vulnerability_id) AS new_vulns
         FROM     assets_vulns                AS av
         WHERE    av.baseline = 'New'
         GROUP BY av.asset_id ), remediated_vulns AS
(
         SELECT   av.asset_id,
                  count (av.vulnerability_id) AS remediated_vulns
         FROM     assets_vulns                AS av
         WHERE    av.baseline = 'Old'
         GROUP BY av.asset_id )
SELECT    CURRENT_DATE               AS date,
          sum(ev.existing_vulns)      AS same_count,
          count(rv.remediated_vulns) AS old_count,
          count(nv.new_vulns)        AS new_count
FROM      existing_vulns             AS ev
FULL JOIN remediated_vulns           AS rv
ON        ev.asset_id = rv.asset_id
FULL JOIN new_vulns AS nv
ON        ev.asset_id = nv.asset_id
GROUP BY  date 
