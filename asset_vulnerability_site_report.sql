SELECT ds.name AS node, fs.assets AS "Total Assets",  COUNT(DISTINCT favf.vulnerability_id) AS unique_vulnerabilities,
	SUM(CASE WHEN dv.severity = 'Critical' THEN 1 ELSE 0 END) AS critical_vulnerabilities,
	SUM(CASE WHEN dv.severity = 'Severe' THEN 1 ELSE 0 END) AS severe_vulnerabilities,
	SUM(CASE WHEN dv.severity = 'Moderate' THEN 1 ELSE 0 END) AS moderate_vulnerabilities
FROM fact_asset_vulnerability_finding favf
JOIN dim_site_asset dsa ON dsa.asset_id  = favf.asset_id
JOIN dim_site ds ON ds.site_id = dsa.site_id
JOIN dim_vulnerability dv ON dv.vulnerability_id = favf.vulnerability_id
JOIN fact_site fs ON fs.site_id = ds.site_id
GROUP BY dsa.site_id, ds.name, fs.assets
